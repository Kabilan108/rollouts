# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Common Commands

### Development Environment
```bash
# Enter development shell with deploy-rs and Node.js
nix develop

# Install Claude Code (if not already available)
npm install -g @anthropic-ai/claude-code
```

### Server Deployment
```bash
# Deploy the heighliner server configuration
deploy .#heighliner

# Build the NixOS configuration locally (for testing)
nix build .#nixosConfigurations.heighliner.config.system.build.toplevel

# Check deployment configuration
nix flake check
```

### Image Building
```bash
# Build DigitalOcean image
cd images && nix-build digitalocean.nix
```

## Architecture Overview

NixOS server deployment using deploy-rs with Traefik as reverse proxy and Docker as the container backend. Application configs are generated by the rollout CLI and imported automatically.

### Core Components
- `flake.nix` - Build and deployment configuration with deploy-rs
- `heighliner-config.nix` - Main NixOS server configuration (imports apps dynamically)
- `apps/*.nix` - Per-application container definitions (generated by rollout)
- `traefik.yml` and `traefik-dynamic.yml` - Traefik static/dynamic configuration
- `servers/ports.json` - Port allocation registry maintained by the CLI

### Server Configuration (heighliner)
- Traefik reverse proxy with Let's Encrypt (Cloudflare DNS challenge configured in secrets)
- Docker enabled with `virtualisation.oci-containers.backend = "docker"`
- Dynamic app loading: `servers/apps/*.nix` are imported automatically
- Firewall: ports 22, 80, 443 opened
- SSH key-only authentication; root login via keys only
- Dotfiles auto-cloned on activation for the root user (NeoVim default editor)

### Key Features
- Automated, atomic deployments with deploy-rs
- Traefik discovers containers via Docker labels (set by rollout)
- SSL certs managed automatically via Let's Encrypt
- Weekly garbage collection and Docker pruning

### Deployment Target
- Hostname: `heighliner`
- User: `root`
- Method: SSH with deploy-rs activation scripts

### Secrets
- Managed with agenix; system secrets in `servers/secrets/system.age`
- App-specific env files live at `servers/apps/<app>.age` and are referenced by app configs
